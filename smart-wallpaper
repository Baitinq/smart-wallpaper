#!/bin/bash

input_daytimewallpaper=''
input_nighttimewallpaper=''
daytimewallpaper=''
nighttimewallpaper=''
location=''

print_usage() {
  echo "Usage: smart-wallpaper [FLAG]"
  echo "  Flags:"
  echo "    [-d]: NEEDED   : daytime wallpaper file/folder"
  echo "    [-n]: NEEDED   : nighttime wallpaper file/folder"
  echo "    [-l]: OPTIONAL : manual location, if not added geoclue gets the location (requires internet)"
  echo "    [-h]: OPTIONAL : print help message"
}

set_wallpaper() {
  #if [[ $1 == *".gif" ]]; then
  #  mplayer
  #else
    feh --bg-fill $1
}

if (( $# == 0 )); then
    print_usage
    exit 1
fi

while getopts 'd:n:l:h' flag; do
  case "${flag}" in
    d) input_daytimewallpaper="${OPTARG}"    ;;
    n) input_nighttimewallpaper="${OPTARG}"  ;;
    l) location="${OPTARG}"                  ;;
    h) print_usage
       exit 0                                ;;
    *) print_usage
       exit 1                                ;;
  esac
done

if [ "$input_daytimewallpaper" == "" ]; then
  print_usage
  exit 1
fi

if [ "$input_nighttimewallpaper" == "" ]; then
  print_usage
  exit 1
fi

daytimewallpaper=$(find $input_daytimewallpaper -type f | shuf -n 1)
nighttimewallpaper=$(find $input_nighttimewallpaper -type f | shuf -n 1)

while true
do

  if [ "$location" != "" ]; then
    string=$(redshift -l $location -p)
    if [[ $string == *"Daytime"* ]]; then
      set_wallpaper "$daytimewallpaper"
    else
      set_wallpaper "$nighttimewallpaper"
    fi
  else
    string=$(redshift -p)
    if [[ $string == *"Daytime"* ]]; then
      set_wallpaper "$daytimewallpaper"
    else
      set_wallpaper "$nighttimewallpaper"
    fi
  fi

  sleep 500s
done
